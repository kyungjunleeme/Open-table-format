# ğŸ§Š PyIceberg Timestamp Precision Playground (í•œê¸€íŒ)

> **Apache Iceberg / PyIcebergì˜ timestamp[ns] â†’ timestamp[us] ë³€í™˜ ë¬¸ì œë¥¼ ì¬í˜„í•˜ê³  ì‹œê°ì ìœ¼ë¡œ ì‹¤í—˜í•  ìˆ˜ ìˆëŠ” Streamlit ê¸°ë°˜ ë„êµ¬**

---

## ğŸ¯ ê°œìš”

ì´ í”„ë¡œì íŠ¸ëŠ” **PyIcebergì˜ timestamp ì •ë°€ë„ ë³€í™˜ ë¬¸ì œ**ë¥¼ ë‹¨ê³„ë³„ë¡œ ì¬í˜„í•˜ê³ ,  
UIë¥¼ í†µí•´ **append / add_files** ë™ì‘ì˜ ì°¨ì´ë¥¼ ì§ê´€ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ë§Œë“  ì‹¤í—˜ìš© ì•±ì…ë‹ˆë‹¤.

PyArrowì™€ MinIO(S3)ë¥¼ í•¨ê»˜ í™œìš©í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì„ ì‹œê°í™”í•©ë‹ˆë‹¤:

1. Parquet ë°ì´í„° ìƒì„± (timestamp[ns])  
2. MinIO(S3)ì— ì—…ë¡œë“œ  
3. PyIceberg `append()` ë˜ëŠ” `add_files()`ë¡œ í…Œì´ë¸”ì— ë°˜ì˜  
4. Iceberg ë©”íƒ€ë°ì´í„° ì¡°íšŒ ë° ì •ë°€ë„ í™•ì¸  
5. ìˆ˜ë™ í¸ì§‘(Manual Row Editor)ì„ í†µí•œ ë°ì´í„° ì§ì ‘ ì‹¤í—˜

---

## ğŸ§± ì£¼ìš” ê¸°ëŠ¥

| ë‹¨ê³„ | ëª©ì  | ì„¤ëª… |
|------|------|------|
| **Step 1 â€” ë°ì´í„° ìƒì„± ë° í¸ì§‘** | íƒ€ì„ìŠ¤íƒ¬í”„ ì»¬ëŸ¼ ìƒì„±, í¸ì§‘, ìºìŠ¤íŒ… | PyArrow ê¸°ë°˜ nsâ†”us ë³€í™˜ ì§€ì› |
| **Step 1b â€” ë¹ ë¥¸ ìƒì„±(Quick Generate)** | í…ŒìŠ¤íŠ¸ìš© Parquet ë°ì´í„° ì¦‰ì‹œ ìƒì„± | ì»¤ìŠ¤í…€ íŒŒì¼ëª… ì§€ì • ê°€ëŠ¥ |
| **Step 2 â€” MinIO ì—…ë¡œë“œ** | Parquet íŒŒì¼ì„ S3(MinIO)ì— ì—…ë¡œë“œ | í™˜ê²½ë³€ìˆ˜ë¡œ ê²½ë¡œ ì§€ì • ê°€ëŠ¥ |
| **Step 3 â€” Append / Add_Files í…ŒìŠ¤íŠ¸** | `append()` vs `add_files()` ì°¨ì´ ë¹„êµ | ë‹¤ìš´ìºìŠ¤íŠ¸ ì—¬ë¶€ í™•ì¸ |
| **Step 4 â€” ë©”íƒ€ë°ì´í„° ì¡°íšŒ** | Iceberg í…Œì´ë¸”ì˜ schema, snapshot, manifest í™•ì¸ | ì‹¤ì‹œê°„ ì •ë°€ë„ ë¹„êµ |
| **Step 5 â€” Manual Row Editor âœï¸** | ìˆ˜ë™ ë°ì´í„° í¸ì§‘ ë° í…Œì´ë¸” ì €ì¥ | íƒ€ê²Ÿ í…Œì´ë¸”ëª… ì§€ì • ê°€ëŠ¥ |
| **Quick Test â€” ì „ì²´ ì‹¤í–‰** | 1~4ë‹¨ê³„ ìë™ ì‹¤í–‰ | í†µí•© í…ŒìŠ¤íŠ¸ ìš©ë„ |
| **Reset & Utilities** | ì„¸ì…˜ ì´ˆê¸°í™” ë° ì„¤ì • ë¦¬ì…‹ | ë¹ ë¥¸ ì¬ì‹¤í–‰ì„ ìœ„í•œ ìœ í‹¸ë¦¬í‹° |

---

## ğŸ§© Target Table Name (íƒ€ê²Ÿ í…Œì´ë¸” ì´ë¦„)

UI í•˜ë‹¨ì˜ **Target table name** í•„ë“œëŠ” ì‹¤ì œ Iceberg í…Œì´ë¸”ì„ ì§€ì •í•˜ê±°ë‚˜ ìƒˆë¡œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆ:  
```
Target table name: test__222.manual
The table will be dropped and recreated with the edited schema.
```

### ğŸ’¡ ì˜ë¯¸

| í•­ëª© | ì„¤ëª… |
|------|------|
| **Target Table** | Iceberg ì¹´íƒˆë¡œê·¸ ë‚´ í…Œì´ë¸” ì´ë¦„ (`namespace.table_name` í˜•íƒœ) |
| **Drop & Recreate** | ê¸°ì¡´ í…Œì´ë¸”ì´ ìˆì„ ê²½ìš° ì‚­ì œ í›„, ìƒˆ ìŠ¤í‚¤ë§ˆë¡œ ì¬ìƒì„± |
| **ì €ì¥ ìœ„ì¹˜** | S3 ë˜ëŠ” warehouse ê²½ë¡œì— ë°ì´í„° íŒŒì¼ ì €ì¥ |
| **ë™ì‘ ì˜ˆì‹œ** | Manual Row Editorì—ì„œ í¸ì§‘í•œ ë°ì´í„°ë¥¼ Iceberg í…Œì´ë¸”ë¡œ ì§ì ‘ ë°˜ì˜ |

```python
from pyiceberg.catalog import load_catalog
from pyiceberg.schema import Schema
from pyiceberg.types import NestedField, LongType, TimestampType

catalog = load_catalog("default")
schema = Schema(
    NestedField(id=1, name="id", field_type=LongType()),
    NestedField(id=2, name="created_at", field_type=TimestampType())
)

table_identifier = "test__222.manual"

try:
    catalog.drop_table(table_identifier)
except Exception:
    pass

table = catalog.create_table(
    identifier=table_identifier,
    schema=schema,
    location="s3://iceberg/warehouse/test__222/manual"
)
```

ì´ë ‡ê²Œ ì§€ì •í•˜ë©´ `test__222.manual` ì´ë¼ëŠ” Iceberg í…Œì´ë¸”ì´ ìƒì„±ë˜ë©°,  
ìˆ˜ì •ëœ ìŠ¤í‚¤ë§ˆê°€ ë°˜ì˜ë©ë‹ˆë‹¤.

---

## âš™ï¸ í™˜ê²½ ì„¤ì •

### 1ï¸âƒ£ í™˜ê²½ êµ¬ì„±
```bash
uv venv .venv && source .venv/bin/activate
uv sync
```

### 2ï¸âƒ£ MinIO ì‹¤í–‰
```bash
docker run -d --name=minio   -e MINIO_ROOT_USER=minioadmin -e MINIO_ROOT_PASSWORD=minioadmin   -p 9000:9000 -p 9001:9001   quay.io/minio/minio:RELEASE.2024-12-18T13-15-44Z   server /data --console-address ":9001"
```

### 3ï¸âƒ£ Streamlit ì‹¤í–‰
```bash
uv run streamlit run src/open_table_format/app.py
```

ë¸Œë¼ìš°ì €ì—ì„œ **http://localhost:8501** ë¡œ ì ‘ì†í•©ë‹ˆë‹¤.

---

## ğŸ§  ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ

1. **Step 1** â€” íƒ€ì„ìŠ¤íƒ¬í”„ ë°ì´í„° ì§ì ‘ ì…ë ¥  
2. **Step 1b** â€” ns ë‹¨ìœ„ Parquet ìƒì„±  
3. **Step 2** â€” MinIOë¡œ ì—…ë¡œë“œ  
4. **Step 3** â€” Append(ì“°ê¸°) / Add_Files(ë“±ë¡) ê°ê° ì‹¤í–‰  
5. **Step 4** â€” ë©”íƒ€ë°ì´í„°ì—ì„œ ì •ë°€ë„ ì°¨ì´ í™•ì¸  
6. **Step 5** â€” ìˆ˜ë™ í¸ì§‘ í›„ ìƒˆë¡œìš´ Iceberg í…Œì´ë¸” ìƒì„±  

---

## ğŸ“˜ ê¸°ìˆ  í¬ì¸íŠ¸

- `PYICEBERG_DOWNCAST_NS_TIMESTAMP_TO_US_ON_WRITE` ì„¤ì •ì— ë”°ë¼ append ì‹œ ë‹¤ìš´ìºìŠ¤íŠ¸ ê°€ëŠ¥  
- `add_files()`ëŠ” íŒŒì¼ ë“±ë¡ë§Œ ìˆ˜í–‰ â†’ ì •ë°€ë„ ë³€í™˜ ì—†ìŒ  
- PyArrow ê¸°ë°˜ nsâ†”us ë³€í™˜ ì‹œê°í™” ì§€ì›  
- Iceberg í…Œì´ë¸” ë©”íƒ€ë°ì´í„°(Schema, Manifest, Snapshot) ì‹¤ì‹œê°„ í™•ì¸ ê°€ëŠ¥  

---

## ğŸ§­ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
src/open_table_format/
â”œâ”€â”€ app.py               # Streamlit UI
â”œâ”€â”€ cli.py               # CLI ëª…ë ¹
â”œâ”€â”€ iceberg_ops.py       # PyArrow + PyIceberg í•µì‹¬ ë¡œì§
tests/
â”œâ”€â”€ test_parquet_precision.py
â”œâ”€â”€ test_e2e.py
pyproject.toml           # ì˜ì¡´ì„± ë° ì„¤ì •
```

---

## ğŸ§© ì´ëŸ° ê²½ìš° ìœ ìš©í•©ë‹ˆë‹¤

| ìƒí™© | ì´ìœ  |
|------|------|
| Iceberg í…Œì´ë¸” ì •ë°€ë„ ë¶ˆì¼ì¹˜ ë””ë²„ê¹… | append/add_files ë™ì‘ ì°¨ì´ ì¬í˜„ |
| Parquetâ†’Iceberg ì´ê´€ ê²€ì¦ | downcast/upcast ë³€í™˜ í™•ì¸ |
| êµìœ¡ìš© / ì‚¬ë‚´ ì„¸ì…˜ | ì‹œê°ì ìœ¼ë¡œ ì •ë°€ë„ ì°¨ì´ ì„¤ëª… ê°€ëŠ¥ |
| ì˜¤í”ˆì†ŒìŠ¤ ê¸°ì—¬ | PyIceberg ì´ìŠˆ ì¬í˜„ ë° ë¦¬í¬íŠ¸ |

---

## ğŸ‘¨â€ğŸ”¬ ê°œë°œì ë…¸íŠ¸

ì´ í”„ë¡œì íŠ¸ëŠ”  
**ë°ì´í„° ì—”ì§€ë‹ˆì–´, Iceberg ê¸°ì—¬ì, PyArrow ì‹¤ë¬´ì**ê°€  
timestamp ì •ë°€ë„ ë¬¸ì œë¥¼ **ì§ì ‘ ëˆˆìœ¼ë¡œ ë³´ê³  ì‹¤í—˜**í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
