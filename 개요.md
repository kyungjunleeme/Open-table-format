# 🧊 PyIceberg Timestamp Precision Playground (한글판)

> **Apache Iceberg / PyIceberg의 timestamp[ns] → timestamp[us] 변환 문제를 재현하고 시각적으로 실험할 수 있는 Streamlit 기반 도구**

---

## 🎯 개요

이 프로젝트는 **PyIceberg의 timestamp 정밀도 변환 문제**를 단계별로 재현하고,  
UI를 통해 **append / add_files** 동작의 차이를 직관적으로 확인할 수 있도록 만든 실험용 앱입니다.

PyArrow와 MinIO(S3)를 함께 활용하여 다음과 같은 과정을 시각화합니다:

1. Parquet 데이터 생성 (timestamp[ns])  
2. MinIO(S3)에 업로드  
3. PyIceberg `append()` 또는 `add_files()`로 테이블에 반영  
4. Iceberg 메타데이터 조회 및 정밀도 확인  
5. 수동 편집(Manual Row Editor)을 통한 데이터 직접 실험

---

## 🧱 주요 기능

| 단계 | 목적 | 설명 |
|------|------|------|
| **Step 1 — 데이터 생성 및 편집** | 타임스탬프 컬럼 생성, 편집, 캐스팅 | PyArrow 기반 ns↔us 변환 지원 |
| **Step 1b — 빠른 생성(Quick Generate)** | 테스트용 Parquet 데이터 즉시 생성 | 커스텀 파일명 지정 가능 |
| **Step 2 — MinIO 업로드** | Parquet 파일을 S3(MinIO)에 업로드 | 환경변수로 경로 지정 가능 |
| **Step 3 — Append / Add_Files 테스트** | `append()` vs `add_files()` 차이 비교 | 다운캐스트 여부 확인 |
| **Step 4 — 메타데이터 조회** | Iceberg 테이블의 schema, snapshot, manifest 확인 | 실시간 정밀도 비교 |
| **Step 5 — Manual Row Editor ✏️** | 수동 데이터 편집 및 테이블 저장 | 타겟 테이블명 지정 가능 |
| **Quick Test — 전체 실행** | 1~4단계 자동 실행 | 통합 테스트 용도 |
| **Reset & Utilities** | 세션 초기화 및 설정 리셋 | 빠른 재실행을 위한 유틸리티 |

---

## 🧩 Target Table Name (타겟 테이블 이름)

UI 하단의 **Target table name** 필드는 실제 Iceberg 테이블을 지정하거나 새로 생성할 수 있습니다.

예:  
```
Target table name: test__222.manual
The table will be dropped and recreated with the edited schema.
```

### 💡 의미

| 항목 | 설명 |
|------|------|
| **Target Table** | Iceberg 카탈로그 내 테이블 이름 (`namespace.table_name` 형태) |
| **Drop & Recreate** | 기존 테이블이 있을 경우 삭제 후, 새 스키마로 재생성 |
| **저장 위치** | S3 또는 warehouse 경로에 데이터 파일 저장 |
| **동작 예시** | Manual Row Editor에서 편집한 데이터를 Iceberg 테이블로 직접 반영 |

```python
from pyiceberg.catalog import load_catalog
from pyiceberg.schema import Schema
from pyiceberg.types import NestedField, LongType, TimestampType

catalog = load_catalog("default")
schema = Schema(
    NestedField(id=1, name="id", field_type=LongType()),
    NestedField(id=2, name="created_at", field_type=TimestampType())
)

table_identifier = "test__222.manual"

try:
    catalog.drop_table(table_identifier)
except Exception:
    pass

table = catalog.create_table(
    identifier=table_identifier,
    schema=schema,
    location="s3://iceberg/warehouse/test__222/manual"
)
```

이렇게 지정하면 `test__222.manual` 이라는 Iceberg 테이블이 생성되며,  
수정된 스키마가 반영됩니다.

---

## ⚙️ 환경 설정

### 1️⃣ 환경 구성
```bash
uv venv .venv && source .venv/bin/activate
uv sync
```

### 2️⃣ MinIO 실행
```bash
docker run -d --name=minio   -e MINIO_ROOT_USER=minioadmin -e MINIO_ROOT_PASSWORD=minioadmin   -p 9000:9000 -p 9001:9001   quay.io/minio/minio:RELEASE.2024-12-18T13-15-44Z   server /data --console-address ":9001"
```

### 3️⃣ Streamlit 실행
```bash
uv run streamlit run src/open_table_format/app.py
```

브라우저에서 **http://localhost:8501** 로 접속합니다.

---

## 🧠 사용 시나리오 예시

1. **Step 1** — 타임스탬프 데이터 직접 입력  
2. **Step 1b** — ns 단위 Parquet 생성  
3. **Step 2** — MinIO로 업로드  
4. **Step 3** — Append(쓰기) / Add_Files(등록) 각각 실행  
5. **Step 4** — 메타데이터에서 정밀도 차이 확인  
6. **Step 5** — 수동 편집 후 새로운 Iceberg 테이블 생성  

---

## 📘 기술 포인트

- `PYICEBERG_DOWNCAST_NS_TIMESTAMP_TO_US_ON_WRITE` 설정에 따라 append 시 다운캐스트 가능  
- `add_files()`는 파일 등록만 수행 → 정밀도 변환 없음  
- PyArrow 기반 ns↔us 변환 시각화 지원  
- Iceberg 테이블 메타데이터(Schema, Manifest, Snapshot) 실시간 확인 가능  

---

## 🧭 디렉토리 구조

```
src/open_table_format/
├── app.py               # Streamlit UI
├── cli.py               # CLI 명령
├── iceberg_ops.py       # PyArrow + PyIceberg 핵심 로직
tests/
├── test_parquet_precision.py
├── test_e2e.py
pyproject.toml           # 의존성 및 설정
```

---

## 🧩 이런 경우 유용합니다

| 상황 | 이유 |
|------|------|
| Iceberg 테이블 정밀도 불일치 디버깅 | append/add_files 동작 차이 재현 |
| Parquet→Iceberg 이관 검증 | downcast/upcast 변환 확인 |
| 교육용 / 사내 세션 | 시각적으로 정밀도 차이 설명 가능 |
| 오픈소스 기여 | PyIceberg 이슈 재현 및 리포트 |

---

## 👨‍🔬 개발자 노트

이 프로젝트는  
**데이터 엔지니어, Iceberg 기여자, PyArrow 실무자**가  
timestamp 정밀도 문제를 **직접 눈으로 보고 실험**할 수 있도록 설계되었습니다.
